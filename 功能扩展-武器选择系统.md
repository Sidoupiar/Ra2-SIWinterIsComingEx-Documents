# 功能扩展-武器选择系统

WIC 扩展了武器选择系统。  
现在单位可以使用更多的武器。



## 新的武器选择模式

可以全局或对特定单位启用/禁用【新的武器选择模式】。  
【新的武器选择模式】只影响单位的武器选择，不影响具体的武器。

位于 `rulesmd.ini`：

```ini
[WICControls]
NewSelectWeaponMode=no                            ; yes/no , 全局启用【新的武器选择模式】 , 默认值是 no
```

```ini
[SomeTechnoType]
NewSelectWeaponMode=no                            ; yes/no , 全局启用【新的武器选择模式】 , 默认值是 [WICControls] -> NewSelectWeaponMode 的值
```

### 它如何选择武器

【新的武器选择模式】会按照如下顺序和方式选择武器：

|序号|武器类型|说明|
|:-:|:-:|:-|
|1|特使情况武器|见下方的特殊情况列表，如果不满足特殊条件则正常向下判断。|
|2|战斗要塞武器|如果 `Weapon.OpenTransport.Number=0` 则跳转到选择 `常规武器`，否则正常选择战斗要塞武器，**没有能对目标开火的武器时表现为无武器**。|
|3|部署、无弹药、过载、坠毁武器|满足条件时，选择这些种类的武器，**没有能对目标开火的武器时表现为无武器**。|
|4|短距离武器|如果单位与目标的距离小于 `Weapon.ShortDistance.Amount` 的值时，会选择合适的武器，没有能对目标开火的武器时则跳转到选择 `常规武器`，其他情况则正常向下判断。|
|5|充能武器|目标满足条件时，正常选择充能武器，没有能对目标开火的武器时正常向下判断。|
|6|吸取武器|目标满足条件时，正常选择吸取武器，没有能对目标开火的武器时正常向下判断。|
|7|常规武器|自动选择武器是从第 1 个武器开始依次向后判断的，武器太多可能导致性能问题，判断到可以使用的武器时就会使用这个武器，**而非选择最优武器**。|

有若干特殊情况会限制选择武器：

|序号|使用的武器（【武器索引】）|说明|
|:-:|:-:|:-|
|1|-|驻扎在建筑里的驻军只能使用独立的【驻军武器】。|
|2|`当前炮塔武器`|对于 IFV、光棱坦克等可以切换炮塔的单位，只能使用当前炮塔所对应的武器。|
|3|`当前盖特阶段`|对于 `IsGattling=yes` 的单位，只能使用当前盖特阶段所对应的武器，基于 `Weapon.Normal.List` 列表。|

（在后续的调整中，这些处理可能会有所变化，必要时另见 [迁移说明](/迁移说明.md#迁移说明)）  
（如果对这些特殊处理有更好的方案可以提出来，会酌情调整）

### 兼容性指南

【新的武器选择模式】必然会对原有的武器和单位属性产生深远的影响。  
**理论上来自其他扩展平台的会影响武器选择的功能都会失效。如果你使用了【新的武器选择模式】后遇到了问题，并且下面的内容没有提及，请反馈。**

**如果你没有使用【新的武器选择模式】，则这些属性的含义无变化，仍然遵照原来的用法。**

以下是改变了效果的属性：

位于 `rulesmd.ini`：

```ini
[SomeTechnoType]
LandTargeting=0                                 ; 已失效 , 请使用抛射体的 AG 属性 , 默认值是 0
NavalTargeting=0                                ; 已失效 , 请使用抛射体的 AN 和 AS 属性 , 默认值是 0
```

```ini
[SomeBulletType] ; 抛射体类型
AA=no                                           ; yes/no , 是否可以攻击飞机单位 , 默认值是 no
AL=yes                                          ; yes/no , 是否可以攻击陆地单位 , 默认值是 yes
AN=yes                                          ; yes/no , 是否可以攻击海面单位 , 默认值是 yes
AS=no                                           ; yes/no , 是否可以攻击潜艇单位 , 默认值是 no
AG=yes                                          ; yes/no , 是否可以攻击陆地地板 , 默认值是 yes
AW=yes                                          ; yes/no , 是否可以攻击水面地板 , 默认值是 yes
```



## 虚拟武器

现在任何单位都可以拥有超过 2 个武器。  
虚拟武器和【新的武器选择模式】无关，是另外的功能，它可以实现单位同时持有更多的武器，只是如果没有启用【新的武器选择模式】的话，多出来的这些武器并不能直接被单位使用，而是要通过 [武器选择扩展](/功能扩展-武器选择系统.md#武器选择扩展) 来使用多出来的武器。

位于 `rulesmd.ini`：

```ini
[SomeTechnoType]
; 【武器编号】从 1 开始
WeaponCount=0                                   ; 整数 , 还是原来的含义 , 数值过大可能导致载入不必要的数据甚至弹窗 , 此时请使用 Weapon.Virtual.Count , 默认值是 0
Weapon.Virtual.Count=0                          ; 整数 , 虚拟武器的数量 , 默认值是 [SomeTechnoType] -> WeaponCount 的值
                                                ; 如果单位拥有 Primary 或 Secondary 时会自动更新 Weapon.Virtual.Count 的值
WeaponX=                                        ; 武器 , 第 X 个武器 , 在 Art 中正常写开火位置 , 默认值是 空
```

### 注意

* `Primary` 和 `Secondary` 会分别替换掉 `Weapon1` 和 `Weapon2`，即如果一个单位已经拥有 `Primary` 和 `Secondary` 后，再添加更多武器，就需要从 `Weapon3` 开始写。  
出于稳定性的考量，如果多武器单位（栗如 IFV，盖特等），如果设置了 `Primary` 或 `Secondary`，则需要在 Art 中补充相应的开火坐标。



## 武器选择扩展

在 ini 中，存在一些使用武器索引的属性，栗如 `OpenTransportWeapon`，现在它们可以选择到虚拟武器（即便你没有启用【新的武器选择模式】）。  
对于其他扩展平台中此类属性则不一定能完全生效，需要进行测试后再使用。

位于 `rulesmd.ini`：

```ini
[SomeTechnoType]
; 原有属性 (或其他扩展平台的属性)
; 【武器索引】从 0 开始 , 注意不要超出虚拟武器的数量 , 不然单位会变得不正常甚至弹窗
OpenTransportWeapon=-1                          ; 整数 , 在战斗要塞里使用的【武器索引】 , -1 = 使用默认的战斗要塞武器 (根据目标选择常规武器) , 默认值是 -1
DeployFireWeapon=-1                             ; 整数 , 部署时使用的【武器索引】 , -1 = 使用默认的部署武器 (副武器) , 默认值是 -1
NoAmmoWeapon=-1                                 ; 整数 , 无弹药时使用的【武器索引】 , -1 = 不使用这个武器 , 默认值是 -1
```

```ini
[SomeTechnoType]
; 新增属性 , 取代了原有属性 , 原有属性的值会同步到新属性里
; 数值类型全部统一为【武器编号】 , 【武器编号】 = 【武器索引】 + 1
; 【武器编号】从 1 开始 , 注意不要超出虚拟武器的数量 , 不然单位会变得不正常甚至弹窗
; 【武器数量】是从【武器编号】开始往后多少个武器用于此种情况
; 无效的【武器编号】会被忽略

; 前排提示 :
; 如果没有启用【新的武器选择模式】 , 则下列属性无效

Weapon.Normal.List=                             ; 整数 , 自动选择武器时使用的【武器编号】列表 , 空 = 使用主副武器 , 默认值是 空
                                                ; 对于 DeployFire=yes , Overpowerable=yes 的单位 , 空 = 使用主武器
                                                ; 对于其他情况 , 如果你需要自动修改这个默认值 , 请反馈

Weapon.OpenTransport.List=                      ; 整数 , 在战斗要塞里使用的【武器编号】列表 , 空 = 使用默认的战斗要塞武器 (根据目标选择常规武器) , 默认值是 空
Weapon.DeployFire.List=                         ; 整数 , 部署时使用的【武器编号】列表 , 空 = 使用默认的部署武器 (副武器) , 默认值是 空
Weapon.NoAmmo.List=                             ; 整数 , 无弹药时使用的【武器编号】列表 , 空 = 不使用这种武器 , 默认值是 空
Weapon.Overpowered.List=                        ; 整数 , 过载时使用的【武器编号】列表 , 空 = 使用默认的过载武器 (副武器) , 默认值是 空
Weapon.Kamikaze.List=                           ; 整数 , 飞机类型的单位坠毁时使用的【武器编号】列表 , 空 = 使用默认的坠毁武器 (副武器) , 默认值是 空

Weapon.ShortDistance.Amount=0                   ; 整数 , 单位距离目标小于这个数值时使用的短距离武器 , 默认值是 0 , 单位 : 格点
                                                ; 负数或 0 = 不使用这种武器 , 距离不可能是负数 , 只有完全重叠才是 0 , 0 距离已被排除了
Weapon.ShortDistance.List=                      ; 整数 , 短距离攻击时使用的【武器编号】列表 , 空 = 不使用这种武器 , 默认值是 空

; 请确保区间内的武器均可以执行充能
; 如果有不能充能的武器混在里面 , 可能会出现意外情况
Weapon.Assault.List=                            ; 整数 , 充能时使用的【武器编号】列表 , 空 = 使用默认的充能武器 (副武器) , 默认值是 空

; 请确保区间内的武器均可以执行吸取
; 如果有不能吸取的武器混在里面 , 可能会出现意外情况
Weapon.Drain.Already=yes                        ; yes/no , 是否对已经被吸取的单位使用吸取武器 , 默认值是 yes
Weapon.Drain.IgnoreHouse=no                     ; yes/no , 是否对任意阵营的单位使用吸取武器 , 默认值是 no
Weapon.Drain.List=                              ; 整数 , 吸取时使用的【武器编号】列表 , 空 = 使用默认的吸取武器 (副武器) , 默认值是 空
```



## 其他相关改变

|序号|改变|说明|
|:-:|:-:|:-|
|1|负伤害武器索敌距离|负数伤害的武器的索敌范围改为了武器本身的范围，如果单位有多个负数伤害的武器，则会尝试取最大值。|
|2|拥有治疗武器的建筑|当目标单位的生命值补满之后，建筑就不再尝试治疗目标单位。|