# 功能扩展-经验值和军衔

扩展了经验值获取、升级行为和自定义军衔的功能（强制启用）。

### 注意

* 由于逻辑冲突，已经屏蔽了 ARES 和 Phobos 的自定义军衔，因此可能会丢失一些以前存在的特性（不管是不是有意为之的）。  
由于逻辑冲突，已经屏蔽了 ARES 的经验值相关属性和逻辑，因此可能会丢失一些以前存在的特性（不管是不是有意为之的）。

* 经验值获取逻辑与 Phobos 的数显（显示经验值部分）不兼容，它可能会显示错误的数值。

* 升级的闪烁时间已归回原版设置，由于存在降级，因此 ARES 的 **闪烁规则** 和 **多段升级** 已不适用，之后会改变这个情况。

* 由于兼容多段升级的需要，经验值获取相关的设置不会随着变形而改变（基地车展开和收起除外），而死亡单位提供的经验值会改变。

* 有问题或改进建议请反馈。



## 全局设置

```ini
[General]
VeteranRatio=3                                  ; 浮点数 , 单位升级所需的经验值倍率 , 小于 0 视为 0 处理 , 作为 [SomeTechnoType] -> EXP.Ratio 的默认值使用 , 默认值是 3
VeteranCap=2                                    ; 浮点数 , 单位最多可以升级的次数 , 很难想象这个竟然是浮点数 , 作为 [SomeTechnoType] -> Level.Max 的默认值使用 , 默认值是 2
EnemyInsignia=yes                               ; yes/no , 敌对作战方是否可以看到军衔 (看不到则会隐藏) ， 作为 [SomeTechnoType] -> Insignia.ShowEnemy 的默认值使用 , 默认值是 yes
DefaultInsigniaSet=DefaultInsignia              ; 军衔图像设置 , 显示的军衔的默认值 , 默认值是 DefaultInsignia (即会自动载入 [DefaultInsignia] 块的数据作为此项的值)
```

可以修改 `DefaultInsigniaSet` 的值或是创建（修改） `[DefaultInsignia]` 块来改变默认行为。

### 注意

* 请勿在模式或地图的 ini 中修改上述任何的 `[General]` 块中的属性。



## 提供经验值

可以微调单位死亡后提供的经验值。

位于 `rulesmd.ini`：

```ini
[SomeTechnoType]
EXP.Provide=0                                   ; 浮点数 , 单位死亡后向击杀单位提供的经验值 , 可以是负数 , 但是负数太多可能导致单位升不了级 , 默认值是 Cost 的值 , 单位 : 点
EXP.ProvideOwner=Enemy,Neutral                  ; 作战方归属 , 可用值 : All (无简写) , Self | S , Allies | A , Enemies | E , Neutral | N , 默认值是 Enemy (不区分大小写)
                                                ; 当需要匹配多种作战方时 , 多个值之间使用 "," 符号连接即可 , 栗如同时匹配己方和敌方 : Self,Enemies 或 S,E (简写可以混用 , 不要有空格)
                                                ; 只向符合作战方的单位提供经验值 , 作战方是相对于死亡单位和击杀单位的
```

### 注意

* 暂不支持经验等级提供的经验值加成。



## 获取经验值

定义一个单位如何获取和分配经验值。  
单位实际获得经验值需要 `Trainable=yes`，只影响单位自己，不影响经验值的分配。

位于 `rulesmd.ini`：

```ini
[SomeTechnoType]
; 初始经验值
EXP.StartUp=0                                   ; 浮点数 , 单位出厂时会获得这么多经验值 , 默认值是 0
; 升级经验值
EXP.Cost=0                                      ; 浮点数 , 单位升级所需的经验值 , 需要大于 0 , 默认值是 Cost 的值 , 单位 : 点
EXP.CanReduce=no                                ; yes/no , 单位是否可以接受负数的经验值 , 负数经验值仍会正常分配 , 只是不起作用 , 默认值是 no
EXP.Ratio=3                                     ; 浮点数 , 单位升级所需的经验值倍率 , 小于 0 视为 0 处理 , 默认值是 [General] -> VeteranRatio 的值
EXP.Owner=Enemy,Neutral                         ; 作战方归属 , 可用值 : All (无简写) , Self | S , Allies | A , Enemies | E , Neutral | N , 默认值是 Enemy (不区分大小写)
                                                ; 当需要匹配多种作战方时 , 多个值之间使用 "," 符号连接即可 , 栗如同时匹配己方和敌方 : Self,Enemies 或 S,E (简写可以混用 , 不要有空格)
                                                ; 只吸收符合作战方的单位的经验值 , 作战方是相对于死亡单位和实际获得经验值的单位的
; 载员经验值 , 写载员和载具上
EXP.Passenger=no                                ; yes/no , 载员击杀时 , 载具是否可以获得经验值 , 默认值是 no
EXP.PassengerRatio=1                            ; 浮点数 , 载员击杀时 , 载具可以获得的经验值的比例 , 默认值是 1
EXP.PassengerRatioPass=1                        ; 浮点数 , 载员击杀时 , 载员可以获得的经验值的比例 , 默认值是 1
; 载具经验值 , 写载具上
EXP.Transport=no                                ; yes/no , 载具击杀时 , 载员是否可以获得经验值 , 平均分给各个可以升级的载员 , 默认值是 no
EXP.TransportRatio=1                            ; 浮点数 , 载具击杀时 , 载具可以获得的经验值的比例 , 默认值是 1
EXP.TransportRatioPass=1                        ; 浮点数 , 载具击杀时 , 载员可以获得的经验值的比例 (所有载员均分) , 默认值是 1
; IFV 经验值 , 写 IFV 上
EXP.IFV=no                                      ; yes/no , IFV 击杀时 , IFV 位载员是否可以获得经验值 , 默认值是 no
EXP.IFVRatio=1                                  ; 浮点数 , IFV 击杀时 , 载具可以获得的经验值的比例 , 默认值是 1
EXP.IFVRatioPass=1                              ; 浮点数 , IFV 击杀时 , IFV 位载员可以获得的经验值的比例 , 默认值是 1
; 空袭经验值 , 写空袭召唤者上
EXP.Airstrike=no                                ; yes/no , 召唤者是否可以从空袭中获得经验值 , 默认值是 no
EXP.AirstrikeRatio=1                            ; 浮点数 , 召唤者从空袭中获得的经验值的比例 , 默认值是 1
; 心控经验值 , 写心控者上
EXP.MindControl=no                              ; yes/no , 心控者是否可以获得经验值 , 默认值是 no
EXP.MindControlRatio=1                          ; 浮点数 , 心控者获得的经验值的比例 , 默认值是 1
EXP.MindRatio=1                                 ; 浮点数 , 被心控者获得的经验值的比例 , 默认值是 1
; 航母经验值 , 写航母上
EXP.SpawnOwner=no                               ; yes/no , 航母是否可以获得经验值 , 默认值是 no
EXP.SpawnOwnerRatio=0                           ; 浮点数 , 航母获得的经验值的比例 , 默认值是 0
EXP.SpawnRatio=1                                ; 浮点数 , 舰载机获得的经验值的比例 , 默认值是 1
; 驻军经验值 , 写建筑上
EXP.Occupy=no                                   ; yes/no , 驻军是否可以获得经验值 , 默认值是 no
EXP.OccupyRatio=1                               ; 浮点数 , 建筑获得的经验值的比例 , 默认值是 1
EXP.OccupantRatio=1                             ; 浮点数 , 驻军获得的经验值的比例 , 默认值是 1
```

### 注意

* 与 ARES 的特性会有一些不同：  
启用分配，那么目标单位就会获得一份等额的经验值；  
不启用分配，就不会向任何自己以外的目标分配经验值；  
对于载员通过发动空袭获得经验时，经验并不会分配给载具，则是由于实际获得经验值的单位并不是载员导致的；心控和航母同理；  
由于是重构的逻辑，因此在比较复杂的情况下，可能会出现一个单位获得好几份经验值的情况，如果遇到此种问题，请反馈。

* 载员获得经验值时，对于特定的载具且载具的 `EXP.Passenger=yes` 时，载具上的经验值分配设置会覆盖载员上的。



## 其他经验值获取相关的效果

弹头：详见 [`经验值`](/功能扩展-弹头.md#弹头---经验值)。  
标记：详见 [`加成属性`](/标记逻辑/标记效果-1-杂项.md#加成属性-主动) 和 [`经验值`](/标记逻辑/标记效果-1-杂项.md#经验值-主动)。



## 升级行为

位于 `rulesmd.ini`：

```ini
[SomeTechnoType]
Level.Max=2                                     ; 浮点数 , 单位最多可以升多少级 , 默认值是 [General] -> VeteranCap 的值
Level.SetX=                                     ; 单位升级设置 , 升到或降到 X 级时触发此设置 , 从 0 级开始 , 跨级时挨个生效 (闪烁 , 声音 , 动画 和 类型转换 除外) , 留空表示这级没有任何效果 , 默认值是 空
```

另见 [类型-单位升级设置](/其他新类型/类型-单位升级设置.md#类型-单位升级设置)。

### 注意

* 有几个特殊情况需要注意：  

|序号|说明|
|:-:|:-|
|1|第 0 级是初始级别，单位出厂时会直接处于这个级别，出厂时不算升级到第 0 级；第 1 级是老兵级别；第 2 级是精英级别。|
|2|第 0 级的单位升级设置的效果只能通过降级获得，最高级的单位升级设置的效果只能通过升级获得。|
|3|如果涉及单位降级的话，那么第 0 级也要写单位升级设置，否则降到第 0 级时单位身上已有的加成属性将无法被正确移除。|
|4|如果单位一口气获得了很多经验，那么他是可以一口气升很多级的，中间跳过的单位升级设置的效果会依次获得，但是闪烁、声音、动画 和 类型转换 等这类不同级别会互相覆盖的效果只有最终等级的才能获得。|
|5|对于单位升级设置中填写的变形的单位类型，请勿填写出厂经验，在这种情况下这是一个无效属性，但是会浪费性能；而出厂标记则看实际需求，它们会正常地挂载上。|
|6|单位升级设置的变形也有一定的局限性，如果变形后的单位无法处于单位的当前位置（比如建筑的空间不够、载员的 Size 限制等），那么变形会失败并取消变形动作，并不会等之后有位置了再进行变形。|



## 自定义军衔

位于 `rulesmd.ini`：

```ini
[SomeTechnoType]
; 军衔图像设置
InsigniaSet=                                    ; 军衔图像设置 , 显示的军衔 (此项会覆盖 ARES 的各项对应属性) , 默认值是 [General] -> DefaultInsigniaSet 的值
InsigniaSetEnemy=                               ; 军衔图像设置 , 敌对作战方显示的军衔 , 默认值是 InsigniaSet 属性的值
InsigniaSet.WeaponX=                            ; 军衔图像设置 , Gunner=yes 使用第 X 个武器时显示的军衔 (此项会覆盖 Phobos 的各项对应属性) , 默认值是 InsigniaSet 属性的值
InsigniaSetEnemy.WeaponX=                       ; 军衔图像设置 , Gunner=yes 使用第 X 个武器时敌对作战方显示的军衔 , 默认值是 InsigniaSet.WeaponX 属性的值
InsigniaSet2=                                   ; 军衔图像设置 , 显示的军衔 2 , 这是一个独立的显示位置 , 所以它有什么用呢 , 默认值是 空
; 其他属性
Insignia.ShowEnemy=yes                          ; yes/no , 敌对作战方是否可以看到军衔 (看不到则会隐藏所有的军衔) , 默认值是 [General] -> EnemyInsignia 的值
```

另见 [类型-军衔图像设置](/其他新类型/类型-军衔图像设置.md#类型-军衔图像设置)。



## 与 ARES 的经验值相关属性和逻辑的兼容性

由于属性数量和实际效果并不完全一致，因此暂时不提供属性自动转换，请按需手动调整。（全文搜索 `Experience.`）

受到影响的属性有：

|属性|含义|
|:-:|:-|
|`Experience.FromPassengers`|载具里的乘客开火载具能够得到经验值。|
|`Experience.PromotePassengers`|如果载具满级那么乘客得到经验值。|
|`Experience.PassengerModifier`|如果击杀是由乘客做的，那么所得的经验值比例。|
|`Experience.FromAirstrike`|如果一个击杀由鲍里斯那样的召唤飞机做的, 召唤者能够得到经验值而不是给飞机。|
|`Experience.AirstrikeModifier`|召唤飞机摧毁对方获得的经验值比例。|
|`Experience.MindControlSelfModifier`|控制的单位摧毁敌方，控制者获得的经验值比例。|
|`Experience.MindControlVictimModifier`|控制的单位获得的经验值比例。如果控制者和战斗要塞的所有者不是盟友的话，控制战斗要塞这样的单位，里面的乘客开火摧毁敌方后获得的经验不算在里面。控制友军单位摧毁敌方，控制者不会得经验。|
|`Experience.SpawnOwnerModifier`|子机摧毁敌方单位，航母获得的经验值比例。|
|`Experience.SpawnModifier`|子机摧毁敌方单位，子机获得的经验值比例。|



## 与 ARES 和 Phobos 的自定义军衔的兼容性

现在仍然会读取 ARES 和 Phobos 的自定义军衔的属性。  
由于读取这些属性后会尝试转化为现在的数据结构，因此可能在功能细节上会有所不同。

如果使用了 `InsigniaSet`，则不会再读取 ARES 的相关属性；
如果使用了 `InsigniaSet.WeaponX`，则不会再读取 Phobos 的相关属性；。

以下是一些读取、处理顺序：

1. `InsigniaFrame` 会作为 `InsigniaFrame.Rookie`、`InsigniaFrame.Veteran`、`InsigniaFrame.Elite` 的默认值使用。

2. `Insignia.WeaponN` 会作为 `Insignia.WeaponN.Rookie`、`Insignia.WeaponN.Veteran`、`Insignia.WeaponN.Elite` 的默认值使用。

3. `InsigniaFrame.WeaponN` 会作为 `InsigniaFrame.WeaponN.Rookie`、`InsigniaFrame.WeaponN.Veteran`、`InsigniaFrame.WeaponN.Elite` 的默认值使用。

4. 如果设置了 `InsigniaFrames.WeaponN` 则它的值会尝试覆盖 `InsigniaFrame.WeaponN.Rookie`、`InsigniaFrame.WeaponN.Veteran`、`InsigniaFrame.WeaponN.Elite` 的值（分别对应索引 0、1、2，填写了才尝试覆盖）。

### 注意

* 由于数据结构转化的原因，请避免在模式或地图的 ini 中修改 ARES 和 Phobos 的自定义军衔的属性（指修改无效）。

* 如果使用 ARES 和 Phobos 的自定义军衔的属性来实现效果的话，是不支持新增的属性的，还请注意。