# 功能扩展-经验值和军衔

扩展了经验值获取、升级行为和自定义军衔的功能（强制启用）。

### 注意

* 由于逻辑冲突，已经屏蔽了 ARES 的经验值相关属性和逻辑。  
由于逻辑冲突，已经屏蔽了 ARES 的升级相关属性和逻辑。  
由于逻辑冲突，已经屏蔽了 ARES 和 Phobos 的自定义军衔。

* 经验值获取逻辑与 Phobos 的数显（显示经验值部分）不兼容，它可能会显示错误的数值。

* 目前 Y 键（根据经验等级选择单位）暂时与此逻辑不兼容，它仍然会选择原来等级的单位。  
对于显示问题，可以先尝试修改 `MSG:LittleExperience`、`MSG:Veteran` 和 `MSG:Elite` 的文本来解决。

* 有问题或改进建议请反馈。



## 全局设置

可以修改 `DefaultInsigniaSet` 的值或是创建（修改） `[DefaultInsignia]` 块来改变默认行为。

均位于 `rulesmd.ini`：

```ini
[General]
VeteranRatio=3                                  ; 浮点数 , 单位升级所需的经验值倍率 , 小于 0 视为 0 处理 , 作为 [SomeTechnoType] -> EXP.Ratio 的默认值使用 , 默认值是 3
VeteranCap=2                                    ; 浮点数 , 单位最多可以升级的次数 , 很难想象这个竟然是浮点数 , 作为 [SomeTechnoType] -> Level.Max 的默认值使用 , 默认值是 2
EnemyInsignia=yes                               ; yes/no , 敌对作战方是否可以看到军衔 (看不到则会隐藏) ， 作为 [SomeTechnoType] -> Insignia.ShowEnemy 的默认值使用 , 默认值是 yes
DefaultInsigniaSet=DefaultInsignia              ; 军衔图像设置 , 显示的军衔的默认值 , 默认值是 DefaultInsignia (即会自动载入 [DefaultInsignia] 块的数据作为此项的值)
```

```ini
[LevelControls]
; 升到这个等级时
Up.MultSpeed=0                                  ; 浮点数 , 单位升级到此等级时获得的加成属性 , 默认值是 0
Up.MultArmor=0                                  ; 浮点数 , 单位升级到此等级时获得的加成属性 , 默认值是 0
Up.MultArmorDamage=0                            ; 浮点数 , 单位升级到此等级时获得的加成属性 , 默认值是 0
Up.MultFirePower=0                              ; 浮点数 , 单位升级到此等级时获得的加成属性 , 默认值是 0
Up.MultROF=0                                    ; 浮点数 , 单位升级到此等级时获得的加成属性 , 默认值是 0
Up.MultEXP=0                                    ; 浮点数 , 单位升级到此等级时获得的加成属性 , 默认值是 0
Up.MultEXPProvide=0                             ; 浮点数 , 单位升级到此等级时获得的加成属性 , 默认值是 0
Up.MultEXPCost=0                                ; 浮点数 , 单位升级到此等级时获得的加成属性 , 默认值是 0
; 降到这个等级时
Down.MultSpeed=0                                ; 浮点数 , 单位降级到此等级时获得的加成属性 , 默认值是 0
Down.MultArmor=0                                ; 浮点数 , 单位降级到此等级时获得的加成属性 , 默认值是 0
Down.MultArmorDamage=0                          ; 浮点数 , 单位降级到此等级时获得的加成属性 , 默认值是 0
Down.MultFirePower=0                            ; 浮点数 , 单位降级到此等级时获得的加成属性 , 默认值是 0
Down.MultROF=0                                  ; 浮点数 , 单位降级到此等级时获得的加成属性 , 默认值是 0
Down.MultEXP=0                                  ; 浮点数 , 单位降级到此等级时获得的加成属性 , 默认值是 0
Down.MultEXPProvide=0                           ; 浮点数 , 单位降级到此等级时获得的加成属性 , 默认值是 0
Down.MultEXPCost=0                              ; 浮点数 , 单位降级到此等级时获得的加成属性 , 默认值是 0
```

### 注意

* 请勿在模式或地图的 ini 中修改上述任何的 `[General]` 块中的属性。



## 提供经验值

可以微调单位死亡后提供的经验值。

位于 `rulesmd.ini`：

```ini
[SomeTechnoType]
EXP.Provide=0                                   ; 浮点数 , 单位死亡后向击杀单位提供的经验值 , 可以是负数 , 但是负数太多可能导致单位升不了级 , 默认值是 Cost 的值 , 单位 : 点
EXP.ProvideOwner=Enemy,Neutral                  ; 作战方归属 , 可用值 : All (无简写) , Self | S , Allies | A , Enemies | E , Neutral | N , 默认值是 Enemy (不区分大小写)
                                                ; 当需要匹配多种作战方时 , 多个值之间使用 "," 符号连接即可 , 栗如同时匹配己方和敌方 : Self,Enemies 或 S,E (简写可以混用 , 不要有空格)
                                                ; 只向符合作战方的单位提供经验值 , 作战方是相对于死亡单位和击杀单位的
```

### 注意

* 暂不支持经验等级提供的经验值加成。



## 获取经验值

定义一个单位如何获取和分配经验值。  
单位实际获得经验值需要 `Trainable=yes`，只影响单位自己，不影响经验值的分配。

位于 `rulesmd.ini`：

```ini
[SomeTechnoType]
; 初始经验值
EXP.StartUp=0                                   ; 浮点数 , 单位出厂时会获得这么多经验值 , 默认值是 0
; 升级经验值
EXP.Cost=0                                      ; 浮点数 , 单位升级所需的经验值 , 需要大于 0 (否则后果自负) , 默认值是 Cost 的值 , 单位 : 点
EXP.CanReduce=no                                ; yes/no , 单位是否可以接受负数的经验值 , 负数经验值仍会正常分配 , 只是不起作用 , 默认值是 no
EXP.Ratio=3                                     ; 浮点数 , 单位升级所需的经验值倍率 , 小于 0 视为 0 处理 , 默认值是 [General] -> VeteranRatio 的值
EXP.Owner=Enemy,Neutral                         ; 作战方归属 , 可用值 : All (无简写) , Self | S , Allies | A , Enemies | E , Neutral | N , 默认值是 Enemy (不区分大小写)
                                                ; 当需要匹配多种作战方时 , 多个值之间使用 "," 符号连接即可 , 栗如同时匹配己方和敌方 : Self,Enemies 或 S,E (简写可以混用 , 不要有空格)
                                                ; 只吸收符合作战方的单位的经验值 , 作战方是相对于死亡单位和实际获得经验值的单位的
; 载员经验值 , 写载员或载具上
; 载员控制载员自己 , 载具控制所有载员 , 载具优先级更高一点
EXP.Passenger=no                                ; yes/no , 载员击杀时 , 载具是否可以获得经验值 , 默认值是 no
EXP.PassengerRatio=1                            ; 浮点数 , 载员击杀时 , 载具可以获得的经验值的比例 , 默认值是 1
EXP.PassengerRatioPass=1                        ; 浮点数 , 载员击杀时 , 载员可以获得的经验值的比例 , 默认值是 1
; 载具经验值 , 写载具上
EXP.Transport=no                                ; yes/no , 载具击杀时 , 载员是否可以获得经验值 , 平均分给各个可以升级的载员 , 默认值是 no
EXP.TransportRatio=1                            ; 浮点数 , 载具击杀时 , 载具可以获得的经验值的比例 , 默认值是 1
EXP.TransportRatioPass=1                        ; 浮点数 , 载具击杀时 , 载员可以获得的经验值的比例 (所有载员均分) , 默认值是 1
; IFV 经验值 , 写 IFV 上
EXP.IFV=no                                      ; yes/no , IFV 击杀时 , IFV 位载员是否可以获得经验值 , 默认值是 no
EXP.IFVRatio=1                                  ; 浮点数 , IFV 击杀时 , 载具可以获得的经验值的比例 , 默认值是 1
EXP.IFVRatioPass=1                              ; 浮点数 , IFV 击杀时 , IFV 位载员可以获得的经验值的比例 , 默认值是 1
; 空袭经验值 , 写空袭召唤者上
EXP.Airstrike=no                                ; yes/no , 召唤者是否可以从空袭中获得经验值 , 默认值是 no
EXP.AirstrikeRatio=1                            ; 浮点数 , 召唤者从空袭中获得的经验值的比例 , 默认值是 1
; 心控经验值 , 写心控者上
EXP.MindControl=no                              ; yes/no , 心控者是否可以获得经验值 , 默认值是 no
EXP.MindControlRatio=1                          ; 浮点数 , 心控者获得的经验值的比例 , 默认值是 1
EXP.MindRatio=1                                 ; 浮点数 , 被心控者获得的经验值的比例 , 默认值是 1
; 航母经验值 , 写航母上
EXP.SpawnOwner=no                               ; yes/no , 航母是否可以获得经验值 , 默认值是 no
EXP.SpawnOwnerRatio=0                           ; 浮点数 , 航母获得的经验值的比例 , 默认值是 0
EXP.SpawnRatio=1                                ; 浮点数 , 舰载机获得的经验值的比例 , 默认值是 1
; 驻军经验值 , 写建筑上
EXP.Occupy=no                                   ; yes/no , 驻军是否可以获得经验值 , 默认值是 no
EXP.OccupyRatio=1                               ; 浮点数 , 建筑获得的经验值的比例 , 默认值是 1
EXP.OccupantRatio=1                             ; 浮点数 , 驻军获得的经验值的比例 , 默认值是 1
```

### 注意

* 与 ARES 的特性会有一些不同：  
启用分配，那么目标单位就会获得一份等额的经验值；  
不启用分配，就不会向任何自己以外的目标分配经验值；  
对于载员通过发动空袭获得经验时，经验并不会分配给载具，则是由于实际获得经验值的单位并不是载员导致的；心控和航母同理；  
由于是重构的逻辑，因此在比较复杂的情况下，可能会出现一个单位获得好几份经验值的情况，如果遇到此种问题，请反馈。

* 载员获得经验值时，对于特定的载具且载具的 `EXP.Passenger=yes` 时，载具上的经验值分配设置会覆盖载员上的。



## 其他经验值获取相关的效果

弹头：详见 [`经验值`](/功能扩展-弹头.md#弹头---经验值)。  
标记：详见 [`加成属性`](/标记逻辑/标记效果-1-杂项.md#加成属性-主动) 和 [`经验值`](/标记逻辑/标记效果-1-杂项.md#经验值-主动)。



## 升级行为

位于 `rulesmd.ini`：

```ini
[SomeTechnoType]
Level.Max=2                                     ; 浮点数 , 单位最多可以升多少级 , 默认值是 [General] -> VeteranCap 的值
Level.SetX=                                     ; 单位升级设置 , 升到或降到 X 级时触发此设置 , 从等级 0 开始 , 跨级时挨个生效 (闪烁 , 声音 , 动画 和 类型转换 除外) , 留空表示这级没有任何效果 , 默认值是 空
```

另见 [类型-单位升级设置](/其他新类型/类型-单位升级设置.md#类型-单位升级设置)。

### 注意

* 有几个特殊情况需要注意：  

|序号|说明|
|:-:|:-|
|1|等级 0 是初始级别，单位出厂时会直接处于这个级别，出厂时不算升级到等级 0 ；等级 1 是老兵级别；等级 2 是精英级别。|
|2|等级 0 的效果只能通过降级获得，即便通过负数等级升上来也不会获得等级 0 的效果；最高级的效果只能通过升级获得。|
|3|如果涉及单位降级的话，那么等级 0 也要写单位升级设置，否则降到等级 0 时单位身上已有的加成属性将无法被正确移除。|
|4|如果单位一口气获得了很多经验，那么他是可以一口气升很多级的，中间跳过的等级的效果会依次获得，但是闪烁、声音、动画 和 类型转换 等这类不同级别会互相覆盖的效果只有最终等级的才能获得。|
|5|对于升级变形中的单位类型，请勿填写出厂经验，在这种情况下这是一个无效属性，但是会浪费性能；而出厂标记则看实际需求，它们会正常地挂载上。|
|6|升级变形也有一定的局限性，如果变形后的单位无法处于单位的当前位置（比如建筑的空间不够、载员的 Size 限制等），那么变形会失败并取消变形动作，并不会等之后有位置了再进行变形。|



## 自定义军衔

属性已合并至 [类型-单位升级设置](/其他新类型/类型-单位升级设置.md#类型-单位升级设置)。



## 与 ARES 的经验值相关属性和逻辑的兼容性

由于属性数量和实际效果并不完全一致，因此暂时不提供属性自动转换，请按需手动调整。（全文搜索 `Experience.`）

受到影响的属性有：

|属性|含义|
|:-:|:-|
|`Experience.FromPassengers`|载具里的乘客开火载具能够得到经验值。|
|`Experience.PromotePassengers`|如果载具满级那么乘客得到经验值。|
|`Experience.PassengerModifier`|如果击杀是由乘客做的，那么所得的经验值比例。|
|`Experience.FromAirstrike`|如果一个击杀由鲍里斯那样的召唤飞机做的, 召唤者能够得到经验值而不是给飞机。|
|`Experience.AirstrikeModifier`|召唤飞机摧毁对方获得的经验值比例。|
|`Experience.MindControlSelfModifier`|控制的单位摧毁敌方，控制者获得的经验值比例。|
|`Experience.MindControlVictimModifier`|控制的单位获得的经验值比例。如果控制者和战斗要塞的所有者不是盟友的话，控制战斗要塞这样的单位，里面的乘客开火摧毁敌方后获得的经验不算在里面。控制友军单位摧毁敌方，控制者不会得经验。|
|`Experience.SpawnOwnerModifier`|子机摧毁敌方单位，航母获得的经验值比例。|
|`Experience.SpawnModifier`|子机摧毁敌方单位，子机获得的经验值比例。|



## 与 ARES 的升级相关属性和逻辑的兼容性

全都爆了，以上。

受到影响的属性有：

|属性|含义|
|:-:|:-|
|`Promote.VeteranSound`|单位升级到老兵时播放音效。|
|`Promote.EliteSound`|单位升级到精英时播放音效。|
|`Promote.VeteranFlash`|升级到老兵闪光多长时间。|
|`Promote.EliteFlash`|升级到精英闪光多长时间。|
|`EVA.VeteranPromoted`|当单位升级到老兵时播放 EVA。|
|`EVA.ElitePromoted`|当单位升级到精英时播放 EVA。|
|`Promote.VeteranType`|如果设置了，则当单位升级至老兵级时转换为该单位。|
|`Promote.EliteType`|如果设置了，则当单位升级至精英级时转换为该单位。|
|`Promote.VeteranExperience`|该代码用来给予被老兵转换后的单位初始得到的经验倍率，可以将一个单位转换为另一个无等级的单位。|
|`Promote.EliteExperience`|同上，不过用于精英级转换时。|



## 与 ARES 和 Phobos 的自定义军衔的兼容性

考虑到性能和兼容性，现在 ARES 和 Phobos 的自定义军衔的属性不再受到支持。

受到影响的属性有：

|序号|说明|
|:-:|:-|
|`Insignia.Rookie`|新兵级时的军衔。|
|`Insignia.Veteran`|老兵级时的军衔。|
|`Insignia.Elite`|精英级时的军衔。|
|`InsigniaFrame`|从军衔中使用的帧。|
|`InsigniaFrame.Rookie`|从军衔中使用的帧。|
|`InsigniaFrame.Veteran`|从军衔中使用的帧。|
|`InsigniaFrame.Elite`|从军衔中使用的帧。|
|`Insignia.WeaponN`|使用第 N 个炮台时单位的军衔图标。|
|`Insignia.WeaponN.Rookie`|使用第 N 个炮台时新兵级单位的军衔图标。|
|`Insignia.WeaponN.Veteran`|使用第 N 个炮台时老兵级单位的军衔图标。|
|`Insignia.WeaponN.Elite`|使用第 N 个炮台时精英级单位的军衔图标。|
|`InsigniaFrame.WeaponN`|从军衔中使用的帧。|
|`InsigniaFrame.WeaponN.Rookie`|从军衔中使用的帧。|
|`InsigniaFrame.WeaponN.Veteran`|从军衔中使用的帧。|
|`InsigniaFrame.WeaponN.Elite`|从军衔中使用的帧。|
|`InsigniaFrames.WeaponN`|总体设定新兵级、老兵级和精英级单位从军衔中使用的帧。|