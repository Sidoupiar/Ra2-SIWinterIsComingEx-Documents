# 标记逻辑总体说明

## 总体说明

所有单位都可以被添加标记，一种标记在一个单位身上只能同时挂载一个，如果多次挂载相同的标记，那么它们的挂载持续时间会叠加。  
标记分为四种状态，挂载（Mark），激发（Active），生效（Effect），结束（After），四种状态可以通过一定的方式互相切换。  
并且由四种状态衍生出两个生命周期，挂载期间，激发期间。

### 注意

* 标记的挂载持续时间结束之后标记会被立刻移除，即使它刚生效到一半。

* *标记效果的结算顺序是由标记的 `Order=` 属性决定的，举个栗子，一个减伤标记 `Order=0`，一个承伤标记 `Order=1`，那么就是受到伤害时先减伤再承伤。

* 标记效果对于防御力加成的支持暂时有一定的局限性，不支持扩展平台的各种防御力加成（AE 效果除外），如果单位拥有这些防御力加成，那么伤害结算可能会有偏差。



## 一些术语

|术语|说明|
|:-:|:-|
|标记来源单位|单位 A 通过攻击或其他形式给单位 B 挂载了标记 C，那么单位 A 就是标记 C 的标记来源单位，单位 B 是标记 C 的标记所有者。|
|标记所有者|挂载了标记的单位本体。|



## 状态说明

|状态|说明|
|:-:|:-|
|挂载状态|单位持有标记，但是标记不会带来任何效果，仅仅就是一个标记而已，四个阶段均属于挂载期间。|
|激发状态|已经通知标记生效，但是基于设置，标记可能无法立刻生效，这一期间属于激发，另外生效期间也属于激发期间。|
|生效状态|标记的效果发挥出来了，标记会按照挂载的顺序逐个计算效果。|
|结束状态|此标记已经发挥作用完毕，无法再被激发了。|



## 生命周期

|生命周期|说明|
|:-:|:-|
|挂载期间|从单位获得标记一直到给定的挂载持续时间结束，或一直持续到标记被移除，只要标记处在挂载期间就可以被检测到。|
|激发期间|从标记被激发一直到标记生效结束，或一直持续到标记被移除。|



## 标记的生命周期时间顺序图

时间顺序从左到右：

（画不出来）

### 注意

* 单位被超时空冻结后，标记的时间会暂停。



## 处理阶段

不同的标记效果会在不同的处理阶段参与处理，处理顺序（`Order` 属性）只能影响当前处理阶段参与处理的标记。  
目前标记的处理阶段一共有 10 个，分别是：主动（StageActive），自身（StageSelf），开火（StageFire），攻击（StageAttack），防御（StageDefend），受伤（StageDamaged），治疗（StageHealed），亡语（StageDead），击杀（StageKilled），监听（StageListener）。

一般情况下各个处理阶段的先后顺序：（这些处理阶段之间的先后顺序不是绝对固定的，实际过程中彼此之间会有所穿插）

（画不出来）

### 备注

1. 在【防御处理阶段】处理的是原始伤害（即结算护甲前的伤害）。

2. 受到正伤害（和由标记的效果种类产生的 0 伤害）时会进入【受伤处理阶段】，受到负伤害时会进入【治疗处理阶段】。

3. 在【受伤处理阶段】和【治疗处理阶段】中使用统一的处理顺序以保证正确处理所有相关的标记
因此，在【受伤处理阶段】时，如果处理某一个标记后伤害变为负值（即变成治疗型伤害），则后续会接下一个标记的【治疗处理阶段】，反过来也如此。

4. 【开火处理阶段】只包含单位本体的开火。

5. 【监听处理阶段】是一个独立的处理阶段，它只在接收到广播更新时才会开始处理，且处理顺序（`Order` 属性）无效。

### 注意

* 如果在处理阶段中向单位添加的新的标记，则这个标记在当前处理阶段中不会被处理，即便它的处理顺序非常靠后。



## 概念：自动状态切换

标记是可以进行自动状态切换的。  
状态切换的核心就是几个计时相关的属性，它们决定了何时切换何种状态。  
在任何状态中间，均可以使用切换状态类型的效果立即改变标记的状态。

在默认的自动状态切换中，**生效状态** -> **结束状态** 的切换至少持续 **1** 帧，而其余的状态都可以立即切换。  
此行为可以被一部分效果种类影响，也可以被切换状态类型的效果改变。



## 概念：效果强度值叠加

效果强度值叠加代替了标记叠层。  
若标记允许重复激发，则激发时附带的效果强度值会相互叠加，调整标记的效果强度值类效果不受此限制，单纯叠效果强度值不能激发标记，不激发便没有实际效果。  
这种方式在一定程度上避免了叠层带来的性能开销，代价就是无法更新挂载标记的单位（无法更新标记来源），相同标记叠加只能叠加挂载持续时间。

### 公式

```lua
新效果强度值 = 原效果强度值 + 被附加的效果强度值
```

通常情况下，标记进入挂载状态时会重置效果强度值。



## 概念：效果强度值转换

大多数标记效果中都存在效果强度值转换的概念。  
这是把标记的效果强度值转换为标记的实际效果强度的方式。  
效果强度值是叠层的代替品，这种方式在一定程度上避免了叠层带来的性能开销。

### 公式

```lua
实际参与计算的效果强度值 = min( max( 标记当前的效果强度值 , 参与计算的效果强度值下限 ) , 参与计算的效果强度值上限 )
if 参数参与计算的效果强度值 > 生效区间上限 or 参数参与计算的效果强度值 < 生效区间下限 then
	参数参与计算的效果强度值 = 0
end
实际效果强度         = min( max( 效果的基础数值 + 实际参与计算的效果强度值 * 效果强度值的转换效率 , 效果的数值下限 ) , 效果的数值上限 )
实际数值             = min( max( 对应数据的数值 +-*/ 实际效果强度 , 实际数值的数值下限 ) , 实际数值的数值上限 )
```

|参数|说明|
|:-:|:-|
|效果的基础数值|由 `Power.Bases` 属性指定，默认值是 `0`。|
|效果强度值的转换效率|由 `Power.Mults` 属性指定，默认值是 `0`。|
|效果的数值上限|由 `Power.Maxs` 属性指定，`None` 或 `N` = 不限制，默认值是 `None`（不区分大小写）。|
|效果的数值下限|由 `Power.Mins` 属性指定，`None` 或 `N` = 不限制，默认值是 `None`（不区分大小写）。|
|实际数值的数值上限|由 `Power.Maxs.Total` 属性指定，`None` 或 `N` = 不限制，默认值是 `None`（不区分大小写）。|
|实际数值的数值下限|由 `Power.Mins.Total` 属性指定，`None` 或 `N` = 不限制，默认值是 `None`（不区分大小写）。|
|参与计算的效果强度值上限|由 `Power.Maxs.Real` 属性指定，`None` 或 `N` = 不限制，默认值是 `None`（不区分大小写）。|
|参与计算的效果强度值下限|由 `Power.Mins.Real` 属性指定，`None` 或 `N` = 不限制，默认值是 `None`（不区分大小写）。|
|生效区间上限|由 `Power.Maxs.Effect` 属性指定，`None` 或 `N` = 不限制，默认值是 `None`（不区分大小写）。|
|生效区间下限|由 `Power.Mins.Effect` 属性指定，`None` 或 `N` = 不限制，默认值是 `None`（不区分大小写）。|

### 注意

* 通常情况下，【所占比例】【生命值】【次数】相关的数值都只能是非负数；而【恢复量】【伤害】【增幅】相关的数值则可以是任何数值，负值有可能会反转效果。

### 写法

效果强度值转换由以下 **8** 条属性组成：（全部都是浮点数，使用默认值的项可以不写）

位于 `rulesmd.ini`：

```ini
[SomeMarkType]
Power.Bases=0
Power.Mults=0
Power.Maxs=None
Power.Mins=None
Power.Maxs.Total=None
Power.Mins.Total=None
Power.Maxs.Real=None
Power.Mins.Real=None
Power.Maxs.Effect=None
Power.Mins.Effect=None
```

其中的每一项都代表定义了 **1** 项参数。

如果一个效果种类要求 **3** 项参数，就写成如下形式：（缺项则缺少的那一项使用默认值）

位于 `rulesmd.ini`：

```ini
[SomeMarkType]
Power.Bases=0,0,0
Power.Mults=0,0,0
Power.Maxs=None,None,None
Power.Mins=None,None,None
Power.Maxs.Total=None,None,None
Power.Mins.Total=None,None,None
Power.Maxs.Real=None,None,None
Power.Mins.Real=None,None,None
Power.Maxs.Effect=None,None,None
Power.Mins.Effect=None,None,None
```



## 概念：广播与监听

广播是一个跨标记传递信息的方案，广播源可以更新广播频道，而监听者会在广播频道更新时触发操作。  
部分标记在生效状态时可以发布广播更新和（或）监听广播更新。

发布广播更新的被称为 **广播源**，它可以在多个作战方和多个频道上发布广播更新，可以决定何时发布广播更新，以及决定广播强度。  
监听广播更新的被称为 **监听者**，它可以同时监听多个作战方的多个频道上的广播更新。

**广播源** 发布广播更新后，广播强度并不会褪去，而是持续保留在广播频道中。  
多个 **广播源** 更新同一个广播频道会使广播更新变得频繁，广播强度互相叠加。

为了使系统更加灵活，现在 **监听者** 可以选择 **主动监听模式** 或 **被动监听模式**。

### 主动监听模式

**监听者** 拥有自己的效果周期，主动读取广播频道中的广播强度并执行操作。  
在这种模式下，广播更新不会影响到 **监听者**。

### 被动监听模式

**监听者** 的操作频率完全取决于广播更新的频率，广播不更新 **监听者** 不会触发操作。  
这使得 **广播源** 在一定程度上拥有掌控 **监听者** 的能力，可以统一触发一些操作。

在这种模式下，**监听者** 可以决定触发操作的最高频率（每次操作的最小间隔）。  
如果 **监听者** 同时监听了多个频道，则每个频道更新时，监听者都会触发一次操作。

### 性能提示

过于大量的使用广播可能会给性能造成负担。



## 按处理阶段的标记分类

|主动|自身|开火|攻击|防御|受伤|治疗|亡语|击杀|监听|
|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
|[`空效果`](/标记逻辑/标记效果-0-无效果.md#空效果-主动)||||||||||
|[`无效果`](/标记逻辑/标记效果-0-无效果.md#无效果-主动)||||||||||
|[`引爆弹头`](/标记逻辑/标记效果-1-杂项.md#引爆弹头-主动)||||||||||
||||||||[`死亡时引爆弹头`](/标记逻辑/标记效果-1-杂项.md#死亡时引爆弹头-亡语)|||
|[`发射武器`](/标记逻辑/标记效果-1-杂项.md#发射武器-主动)||||||||||
|[`自瞄武器`](/标记逻辑/标记效果-1-杂项.md#自瞄武器-主动)||||||||||
|||[`替换武器`](/标记逻辑/标记效果-1-杂项.md#替换武器-开火)||||||||
|[`替换死亡武器`](/标记逻辑/标记效果-1-杂项.md#替换死亡武器-主动)||||||||||
|||[`齐射武器`](/标记逻辑/标记效果-1-杂项.md#齐射武器-开火)||||||||
|||[`散射武器`](/标记逻辑/标记效果-1-杂项.md#散射武器-开火)||||||||
|[`投放单位`](/标记逻辑/标记效果-1-杂项.md#投放单位-主动)||||||||||
||||||||[`死亡时投放单位`](/标记逻辑/标记效果-1-杂项.md#死亡时投放单位-亡语)|||
|[`原地去世`](/标记逻辑/标记效果-1-杂项.md#原地去世-主动)||||||||||
||||||||[`连锁死亡`](/标记逻辑/标记效果-1-杂项.md#连锁死亡-亡语)|||
|[`建筑变卖`](/标记逻辑/标记效果-1-杂项.md#建筑变卖-主动)||||||||||
|[`静默状态`](/标记逻辑/标记效果-1-杂项.md#静默状态-主动)||||||||||
|[`嘲讽状态`](/标记逻辑/标记效果-1-杂项.md#嘲讽状态-主动)||||||||||
|[`跳过主动处理阶段`](/标记逻辑/标记效果-1-杂项.md#跳过主动处理阶段-主动)||||||||||
|[`加成属性`](/标记逻辑/标记效果-1-杂项.md#加成属性-主动)||||||||||
|[`经验值`](/标记逻辑/标记效果-1-杂项.md#经验值-主动)||||||||||
|[`弹药调整`](/标记逻辑/标记效果-1-杂项.md#弹药调整-主动)||||||||||
|[`弹药检测`](/标记逻辑/标记效果-1-杂项.md#弹药检测-主动)||||||||||
||||||[`死亡复仇`](/标记逻辑/标记效果-1-杂项.md#死亡复仇-受伤亡语)||[`死亡复仇`](/标记逻辑/标记效果-1-杂项.md#死亡复仇-受伤亡语)|||
||||[`攻击复仇`](/标记逻辑/标记效果-1-杂项.md#攻击复仇-攻击受伤)||[`攻击复仇`](/标记逻辑/标记效果-1-杂项.md#攻击复仇-攻击受伤)|||||
||||||[`受伤复仇`](/标记逻辑/标记效果-1-杂项.md#受伤复仇-受伤)|||||
||||[`死亡殉爆`](/标记逻辑/标记效果-1-杂项.md#死亡殉爆-攻击亡语)||||[`死亡殉爆`](/标记逻辑/标记效果-1-杂项.md#死亡殉爆-攻击亡语)|||
||||[`攻击殉爆`](/标记逻辑/标记效果-1-杂项.md#攻击殉爆-攻击)|||||||
||||[`受伤殉爆`](/标记逻辑/标记效果-1-杂项.md#受伤殉爆-攻击受伤)||[`受伤殉爆`](/标记逻辑/标记效果-1-杂项.md#受伤殉爆-攻击受伤)|||||
|[`标记挂载`](/标记逻辑/标记效果-2-标记处理.md#标记挂载-主动)||||||||||
|[`标记激发`](/标记逻辑/标记效果-2-标记处理.md#标记激发-主动)||||||||||
|[`标记结束`](/标记逻辑/标记效果-2-标记处理.md#标记结束-主动)||||||||||
|[`标记移除`](/标记逻辑/标记效果-2-标记处理.md#标记移除-主动)||||||||||
|[`标记强度`](/标记逻辑/标记效果-2-标记处理.md#标记强度-主动)||||||||||
|[`标记转换`](/标记逻辑/标记效果-2-标记处理.md#标记转换-主动)||||||||||
||||[`攻击标记挂载`](/标记逻辑/标记效果-2-标记处理.md#攻击标记挂载-攻击)|||||||
|||||||||[`击杀标记挂载`](/标记逻辑/标记效果-2-标记处理.md#击杀标记挂载-击杀)||
|[`标记挂载监听`](/标记逻辑/标记效果-2-标记处理.md#标记挂载监听-主动监听)|||||||||[`标记挂载监听`](/标记逻辑/标记效果-2-标记处理.md#标记挂载监听-主动监听)|
|[`标记激发监听`](/标记逻辑/标记效果-2-标记处理.md#标记激发监听-主动监听)|||||||||[`标记激发监听`](/标记逻辑/标记效果-2-标记处理.md#标记激发监听-主动监听)|
|[`标记结束监听`](/标记逻辑/标记效果-2-标记处理.md#标记结束监听-主动监听)|||||||||[`标记结束监听`](/标记逻辑/标记效果-2-标记处理.md#标记结束监听-主动监听)|
|[`标记移除监听`](/标记逻辑/标记效果-2-标记处理.md#标记移除监听-主动监听)|||||||||[`标记移除监听`](/标记逻辑/标记效果-2-标记处理.md#标记移除监听-主动监听)|
|[`标记强度监听`](/标记逻辑/标记效果-2-标记处理.md#标记强度监听-主动监听)|||||||||[`标记强度监听`](/标记逻辑/标记效果-2-标记处理.md#标记强度监听-主动监听)|
|[`伤害承担`](/标记逻辑/标记效果-3-受伤效果.md#伤害承担-主动自身受伤治疗)|[`伤害承担`](/标记逻辑/标记效果-3-受伤效果.md#伤害承担-主动自身受伤治疗)||||[`伤害承担`](/标记逻辑/标记效果-3-受伤效果.md#伤害承担-主动自身受伤治疗)|[`伤害承担`](/标记逻辑/标记效果-3-受伤效果.md#伤害承担-主动自身受伤治疗)||||
|[`伤害格挡`](/标记逻辑//标记效果-3-受伤效果.md#伤害格挡-主动受伤)|||||[`伤害格挡`](/标记逻辑//标记效果-3-受伤效果.md#伤害格挡-主动受伤)|||||
||||||[`伤害分摊`](/标记逻辑/标记效果-3-受伤效果.md#伤害分摊-受伤治疗)|[`伤害分摊`](/标记逻辑/标记效果-3-受伤效果.md#伤害分摊-受伤治疗)||||
||[`伤害免疫`](/标记逻辑/标记效果-3-受伤效果.md#伤害免疫-自身受伤治疗)|||||[`伤害免疫`](/标记逻辑/标记效果-3-受伤效果.md#伤害免疫-自身受伤治疗)|[`伤害免疫`](/标记逻辑/标记效果-3-受伤效果.md#伤害免疫-自身受伤治疗)|||
||||||[`伤害闪避`](/标记逻辑/标记效果-3-受伤效果.md#伤害闪避-受伤治疗)|[`伤害闪避`](/标记逻辑/标记效果-3-受伤效果.md#伤害闪避-受伤治疗)||||
|[`伤害延迟`](/标记逻辑/标记效果-3-受伤效果.md#伤害延迟-主动受伤)|||||[`伤害延迟`](/标记逻辑/标记效果-3-受伤效果.md#伤害延迟-主动受伤)|||||
||||||[`伤害限制`](/标记逻辑/标记效果-3-受伤效果.md#伤害限制-受伤)|||||
||||||[`伤害增幅`](/标记逻辑/标记效果-3-受伤效果.md#伤害增幅-受伤治疗)|[`伤害增幅`](/标记逻辑/标记效果-3-受伤效果.md#伤害增幅-受伤治疗)||||
||||||[`伤害隔离`](/标记逻辑/标记效果-3-受伤效果.md#伤害隔离-受伤)|||||
||||||[`伤害反射`](/标记逻辑/标记效果-3-受伤效果.md#伤害反射-受伤治疗)|[`伤害反射`](/标记逻辑/标记效果-3-受伤效果.md#伤害反射-受伤治疗)||||
||||||[`伤害连锁`](/标记逻辑/标记效果-3-受伤效果.md#伤害连锁-受伤治疗)|[`伤害连锁`](/标记逻辑/标记效果-3-受伤效果.md#伤害连锁-受伤治疗)||||
||||||[`伤害即死`](/标记逻辑/标记效果-3-受伤效果.md#伤害即死-受伤)|||||
||||||[`伤害免死`](/标记逻辑/标记效果-3-受伤效果.md#伤害免死-受伤)|||||
||||[`生命汲取`](/标记逻辑/标记效果-4-生命值.md#生命汲取-攻击)|||||||
|[`生命锁定`](/标记逻辑/标记效果-4-生命值.md#生命锁定-主动自身受伤)|[`生命锁定`](/标记逻辑/标记效果-4-生命值.md#生命锁定-主动自身受伤)||||[`生命锁定`](/标记逻辑/标记效果-4-生命值.md#生命锁定-主动自身受伤)|||||
|[`生命恢复`](/标记逻辑/标记效果-4-生命值.md#生命恢复-主动)||||||||||
|[`生命重置`](/标记逻辑/标记效果-4-生命值.md#生命重置-主动)||||||||||
||||[`攻击增幅`](/标记逻辑/标记效果-5-攻击效果.md#攻击增幅-攻击)|||||||
|[`广播`](/标记逻辑/标记效果-6-广播与监听.md#广播-主动)||||||||||
|[`空白监听`](/标记逻辑/标记效果-6-广播与监听.md#空白监听-主动监听)|||||||||[`空白监听`](/标记逻辑/标记效果-6-广播与监听.md#空白监听-主动监听)|
|[`医院监听`](/标记逻辑/标记效果-6-广播与监听.md#医院监听-主动监听)|||||||||[`医院监听`](/标记逻辑/标记效果-6-广播与监听.md#医院监听-主动监听)|
|[`弹头监听`](/标记逻辑/标记效果-6-广播与监听.md#弹头监听-主动监听)|||||||||[`弹头监听`](/标记逻辑/标记效果-6-广播与监听.md#弹头监听-主动监听)|
|[`操作作战方局部变量-主动`](/标记逻辑/标记效果-502-操作作战方局部变量.md#操作作战方局部变量-主动-主动)||||||||||
||||||||[`操作作战方局部变量-死亡`](/标记逻辑/标记效果-502-操作作战方局部变量.md#操作作战方局部变量-死亡-亡语)|||
|[`判断数值-主动`](/标记逻辑/标记效果-504-判断数值.md#判断数值-主动-主动)||||||||||
||||||||[`判断数值-死亡`](/标记逻辑/标记效果-504-判断数值.md#判断数值-死亡-亡语)|||
|||||||||||