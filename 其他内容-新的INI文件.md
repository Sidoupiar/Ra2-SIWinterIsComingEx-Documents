# 新的 ini 文件

（目前尚未定义 `扩展类型` 的类型）

由于一些难以处理的问题， WIC 定义了一套新的 ini 文件，这些文件主要目的是让 WIC 的扩展类型使用起来更加简单（只有显式标注为 `扩展类型` 的类型才算扩展类型）。



## 文件位置

1. 需要把这些 ini 文件放在和 dll 同级的名为 `WICResources` 的文件夹内，内部的 ini 文件均会被读取（包括子文件夹中的 ini 文件）。

2. 理论上支持中文路径，但是游戏本体不怎么支持中文路径，因此你可以写中文的文件名。

3. 文件名会决定载入顺序，目前没有特别规定顺序，默认是按照文件系统提供的顺序载入。

4. 你可以把 ini 压缩成 zip 文件，它可以正常读取，暂时不支持密码。  
压缩包中不要嵌套文件夹，且使用 `仅存储` 进行压缩，推荐用 7-zip 的 `添加到压缩包...` 功能来制作压缩包。  
目前压缩包功能仅适用于多个文件合并在一起分发和使用的场景，完整的压缩包功能还在开发中。



## 语法要求

1. 基础语法和普通的 ini 文件一样，例如：  
代码块标题要用 `[]` 括起来，并且 `[` 字符是第一个非空白字符；  
每条属性的键值对都需要使用 `=` 连接，等等。

2. 在每行的末尾添加 `\` 符号会把下一行算作当前行的延续。

3. 注释符号是 `;` 和 `#`，可以混用。

4. 这些 ini 文件中区分大小写，包括代码块名称、属性名称、值等信息。  
对于要合并进游戏原本就存在的 ini 文件中的属性名称、值则遵从原本的大小写规则，代码块名称仍然区分大小写。

5. 代码块名称相同的代码块可以多次出现（即使是在同一个文件中），它们的代码会合并在一起，如何合并取决于 `@Mode` 属性。

6. 每个代码块都需要拥有 `@Type` 属性，没有这个属性的代码块会被忽略并在日志文件中输出警告信息。
代码块中的 `@Type` 属性可以随意填写，也可以填写多个扩展类型，使用 `,` 分隔，但是没有与之对应的实际类型的话，数据并不会出现在实际的游戏中。  
支持的类型请见对应的扩展类型，以及下列的特殊 `@Type` 属性值。

7. 每个代码块都可以拥有 `@Alias` 属性，可以填写其他代码块的名称，在读取 ini 代码时会把当前代码块下的所有属性同步到 `@Alias` 指定的代码块中。  
代码块中的 `@Alias` 属性可以接收多个代码块名称，使用 `,` 分隔，可以跨类型跨文件。  
如果在 `@Alias` 属性填写了不存在的代码块，则会创建这个代码块。  
如果代码块中的 `@Type` 属性填写了多个扩展类型，则 `@Alias` 属性会对每个扩展类型都生效一遍。

8. 每个代码块都可以拥有 `@NotLoad` 属性，可以避免这个代码块被载入，只要存在 `@NotLoad` 属性就会发挥效果，和值无关。  
即使代码块中存在 `@NotLoad` 属性，也不会影响 `@Alias` 属性发挥效果。

9. 每个代码块都可以拥有 `@Mode` 属性（区分大小写），它决定了当前代码块的属性如何合并进目标代码块中，默认值是 `@Mode=Merge`。  
`@Mode=Merge` 表示 **添加** 不存在的属性，**替换** 已存在的属性；  
`@Mode=Append` 表示 **添加** 不存在的属性，**保持** 已存在的属性，类似于继承功能；  
`@Mode=Delete` 表示 **移除** 已存在的属性；  
`@Mode=Replace` 表示 **清空** 所有属性，然后把当前代码块中的所有属性添加进去。

10. 理论上支持中文代码，但是不建议在代码中写中文。



## 与原本就存在的 ini 文件合并

可以在新的 ini 文件中给代码块添加特殊 `@Type` 属性值来让它加入游戏原本就存在的 ini 文件中。

|`@Type` 属性值|目标 ini 文件|备注|
|:-|:-|:-|
|`@Type=rule`|rulesmd.ini||
|`@Type=art`|artmd.ini||
|`@Type=sound`|soundmd.ini||
|`@Type=ai`|aimd.ini||
|`@Type=ui`|uimd.ini||
|`@Type=eva`|evamd.ini||
|`@Type=battle`|battlemd.ini||
|`@Type=mission`|missionmd.ini||
|`@Type=mapsel`|mapselmd.ini||

1. 如果目标 ini 文件中存在这个代码块，则进行代码块合并，如何合并取决于 `@Mode` 属性。
这项规则同样适用于注册表。

2. 要合并的块中不要出现中文，否则可能引发兼容性问题。



## 文件限定的代码块默认值

在默认情况下，ini 文件开头的没在任何块下的 ini 代码是无效的代码。  
但是在新的 ini 文件中，它们有用了，它们被用作限定在当前文件内的代码块的默认值。

现在给出一个 ini 文件：

```ini
; 这是文件开头 , 前面不能有代码块
; 在文件开头声明限定在当前文件内的代码块默认值
@Type=rule
Name=no name

[SectionA]
Cost=100
; ...... 其他代码略

[SectionB]
@Type=art
Image=AAA
; ...... 其他代码略
```

读取这个 ini 文件后 `[SectionA]` 和 `[SectionB]` 会分别变成：

```ini
[SectionA]
@Type=rule
Name=no name
Cost=100
; ...... 其他代码略

[SectionB]
@Type=art                    ; 代码块重新声明 @Type 属性覆盖了代码块默认值
Name=no name
Image=AAA
; ...... 其他代码略
```



## 对于 Ares 和 Phobos 添加的 ini 增强的兼容性

理论上应该都是适配的，但是会有细微的不同：

1. 不建议把这些规则带入新的 ini 文件中，并且这些 ini 增强如果在新的 ini 文件中失效也是不修复的，望周知。  
**对于原本存在的 ini 文件（如 `rulesmd.ini`、`artmd.ini` 等等）则不受影响，该怎么写还怎么写就行，但是仍然不建议使用 Ares 的继承逻辑**。

2. 对于 Ares 的 `+` 注册逻辑，它在事实上失效了，但是 WIC 承接了这部分功能，遇到 `+` 时会把属性值（等号后面的部分）作为标签使用。  
实际效果可以参考下面的栗子：

文件中的 ini 代码：

```ini
[BuildingTypes]
1=GAPOWR
2=GACNST
; ...... 中间略
+=GAPOWRT
+=GAPOWRW
```

当 ini 被读取后，它实际上会变为（仍保持原本的代码顺序）：

```ini
[BuildingTypes]
1=GAPOWR
2=GACNST
; ...... 中间略
GAPOWRT=GAPOWRT
GAPOWRW=GAPOWRW
```